@model CosmeticShopWeb.Models.ProductListViewModel

@{
    ViewData["Title"] = Model.SelectedCategoryId > 0 ?
        $"Каталог - {Model.Categories.FirstOrDefault(c => c.IdCategory == Model.SelectedCategoryId)?.NameCa ?? "Категория"}" :
        "Каталог товаров";

    var selectedCategory = Model.Categories.FirstOrDefault(c => c.IdCategory == Model.SelectedCategoryId);
}
<link rel="stylesheet" href="~/css/products.css" />

<!-- Герой секция каталога -->
<section class="catalog-hero">
    <div class="catalog-hero-content">
        <h1 class="catalog-title">
            @if (selectedCategory != null)
            {
                <text>@selectedCategory.NameCa <span class="gradient-text">@selectedCategory.Icon</span></text>
            }
            else
            {
                <text>Наша <span class="gradient-text">косметика</span></text>
            }
        </h1>
        <p class="catalog-subtitle">
            @if (selectedCategory != null)
            {
                <text>@selectedCategory.DescriptionCa</text>
            }
            else
            {
                <text>Откройте для себя мир премиальной косметики от лучших брендов</text>
            }
        </p>

        @if (selectedCategory != null)
        {
            <div class="catalog-breadcrumb">
                <a asp-controller="Products" asp-action="Index">Все товары</a>
                <span> / </span>
                <span>@selectedCategory.NameCa</span>
            </div>
        }
    </div>
    <div class="catalog-visual">
        <div class="floating-beauty">
            <div class="beauty-orb"></div>
            <div class="beauty-orb"></div>
            <div class="beauty-orb"></div>
        </div>
    </div>
</section>

<!-- Фильтры и категории -->
<section class="filters-section">
    <div class="container">
        <div class="filters-container">
            <div class="categories-filter">
                <h3>Категории</h3>
                <div class="categories-grid">
                    <!-- Все товары -->
                    <a asp-controller="Products" asp-action="Index"
                       class="category-filter-card @(Model.SelectedCategoryId == 0 ? "active" : "")">
                        <div class="category-filter-icon">📦</div>
                        <span>Все товары</span>
                        <span class="category-count">@Model.TotalCount</span>
                    </a>

                    @foreach (var category in Model.Categories.Where(c => c.IdCategory > 0))
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@category.IdCategory"
                           class="category-filter-card @(Model.SelectedCategoryId == category.IdCategory ? "active" : "")">
                            <div class="category-filter-icon">@category.Icon</div>
                            <span>@category.NameCa</span>
                            <span class="category-count">@category.ProductCount</span>
                        </a>
                    }
                </div>
            </div>

            <div class="search-sort">
                <form method="get" class="search-form">
                    <div class="search-box">
                        <input type="text" name="search" placeholder="Поиск товаров..." value="@Model.SearchTerm">
                        <button type="submit" class="search-icon">🔍</button>
                    </div>
                    @if (Model.SelectedCategoryId > 0)
                    {
                        <input type="hidden" name="categoryId" value="@Model.SelectedCategoryId" />
                    }
                </form>

                <select id="sortSelect" class="sort-select">
                    <option value="name">По названию</option>
                    <option value="price-low">Сначала дешевые</option>
                    <option value="price-high">Сначала дорогие</option>
                    <option value="brand">По бренду</option>
                </select>
            </div>
        </div>
    </div>
</section>

<section class="products-section">
    <div class="container">
        <div class="products-header">
            <h2>Найдено товаров: <span id="productsCount">@Model.Products.Count</span></h2>

            @if (Model.TotalPages > 1)
            {
                <div class="pagination">
                    @if (Model.CurrentPage > 1)
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@Model.SelectedCategoryId"
                           asp-route-search="@Model.SearchTerm"
                           asp-route-page="@(Model.CurrentPage - 1)"
                           class="pagination-btn">← Назад</a>
                    }

                    <span class="pagination-info">Страница @Model.CurrentPage из @Model.TotalPages</span>

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@Model.SelectedCategoryId"
                           asp-route-search="@Model.SearchTerm"
                           asp-route-page="@(Model.CurrentPage + 1)"
                           class="pagination-btn">Далее →</a>
                    }
                </div>
            }
        </div>

        <div class="products-grid" id="productsGrid">
            @foreach (var product in Model.Products)
            {
                <div class="product-card" data-category="@product.CategoryId"
                     data-name="@product.NamePr.ToLower()"
                     data-brand="@product.BrandPr.ToLower()"
                     data-price="@product.Price">

                    <div class="product-image">
                        <div class="product-badge @product.StockStatusClass">
                            @product.StockStatus
                        </div>
                        <div class="product-actions">
                            <button class="wishlist-btn" data-product-id="@product.IdProduct">❤️</button>
                            <a asp-controller="Products" asp-action="Details" asp-route-id="@product.IdProduct"
                               class="quick-view-btn">👁️</a>
                        </div>
                    </div>

                    <div class="product-info">
                        <span class="product-brand">@product.BrandPr</span>
                        <h3 class="product-name">
                            <a asp-controller="Products" asp-action="Details" asp-route-id="@product.IdProduct">
                                @product.NamePr
                            </a>
                        </h3>
                        <p class="product-description">
                            @(product.DescriptionPr.Length > 100 ?
                                                    product.DescriptionPr.Substring(0, 100) + "..." :
                                                    product.DescriptionPr)
                    </p>
                    <div class="product-price">@product.FormattedPrice</div>

                        <div class="product-meta">
                            <span class="product-category">
                                <span class="category-icon">@product.CategoryIcon</span>
                                @product.CategoryName
                            </span>
                        @if (product.StockQuantity > 0)
                            {
                                <span class="product-stock">Осталось: @product.StockQuantity</span>
                            }
                        </div>

                        <form asp-controller="Cart" asp-action="Add" method="post" class="w-100">
                            <input type="hidden" name="productId" value="@product.IdProduct" />
                            <input type="hidden" name="name" value="@product.NamePr" />
                            <input type="hidden" name="price" value="@product.Price" />
                            <input type="hidden" name="quantity" value="1" />

                            <button type="submit" class="add-to-cart-btn @(product.StockQuantity == 0 ? "disabled" : "")"
                                    data-product-id="@product.IdProduct"
                                    @(product.StockQuantity == 0 ? "disabled" : "")>
                                <span>@(product.StockQuantity == 0 ? "Нет в наличии" : "В корзину")</span>
                                <div class="cart-icon">@(product.StockQuantity == 0 ? "❌" : "🛒")</div>
                            </button>
                        </form>

                    </div>
                </div>
            }
        </div>

        @if (!Model.Products.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">😔</div>
                <h3>Товары не найдены</h3>
                <p>Попробуйте изменить параметры поиска или выбрать другую категорию</p>
                <a asp-controller="Products" asp-action="Index" class="reset-filters-btn">Сбросить фильтры</a>
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <div class="pagination-bottom">
                <div class="pagination">
                    @if (Model.CurrentPage > 1)
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@Model.SelectedCategoryId"
                           asp-route-search="@Model.SearchTerm"
                           asp-route-page="@(Model.CurrentPage - 1)"
                           class="pagination-btn">← Назад</a>
                    }

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@Model.SelectedCategoryId"
                           asp-route-search="@Model.SearchTerm"
                           asp-route-page="@i"
                           class="pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</a>
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a asp-controller="Products" asp-action="Index"
                           asp-route-categoryId="@Model.SelectedCategoryId"
                           asp-route-search="@Model.SearchTerm"
                           asp-route-page="@(Model.CurrentPage + 1)"
                           class="pagination-btn">Далее →</a>
                    }
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Клиентская сортировка
            const sortSelect = document.getElementById('sortSelect');
            const productsGrid = document.getElementById('productsGrid');

            sortSelect.addEventListener('change', function() {
                sortProducts(this.value);
            });

            function sortProducts(sortBy) {
                const container = productsGrid;
                const items = Array.from(container.querySelectorAll('.product-card'));

                items.sort((a, b) => {
                    const aPrice = parseFloat(a.getAttribute('data-price'));
                    const bPrice = parseFloat(b.getAttribute('data-price'));
                    const aName = a.getAttribute('data-name');
                    const bName = b.getAttribute('data-name');
                    const aBrand = a.getAttribute('data-brand');
                    const bBrand = b.getAttribute('data-brand');

                    switch (sortBy) {
                        case 'name':
                            return aName.localeCompare(bName);
                        case 'price-low':
                            return aPrice - bPrice;
                        case 'price-high':
                            return bPrice - aPrice;
                        case 'brand':
                            return aBrand.localeCompare(bBrand);
                        default:
                            return 0;
                    }
                });

                items.forEach(item => container.appendChild(item));
            }

            // Добавление в корзину через AJAX
            const addToCartForms = document.querySelectorAll('form[asp-controller="Cart"]');
            addToCartForms.forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const submitBtn = this.querySelector('.add-to-cart-btn');

                    if (submitBtn.disabled) return;

                    try {
                        const response = await fetch(this.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Анимация успеха
                            const originalHTML = submitBtn.innerHTML;
                            submitBtn.innerHTML = '<span>Добавлено!</span><div class="cart-icon">✅</div>';
                            submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';

                            // Обновляем счетчик корзины в навигации
                            updateCartCount(result.cartCount);

                            setTimeout(() => {
                                submitBtn.innerHTML = originalHTML;
                                submitBtn.style.background = '';
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('Ошибка добавления в корзину:', error);
                    }
                });
            });

            function updateCartCount(count) {
                const cartCounter = document.querySelector('.cart-count');
                if (cartCounter) {
                    cartCounter.textContent = count;
                    cartCounter.style.display = count > 0 ? 'inline' : 'none';
                }
            }

            // Загружаем количество товаров в корзине при загрузке страницы
            fetch('/Cart/GetCartCount')
                .then(response => response.json())
                .then(data => {
                    updateCartCount(data.count);
                });

            // Избранное
            const wishlistBtns = document.querySelectorAll('.wishlist-btn');
            wishlistBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    toggleWishlist(productId, this);
                });
            });

            function toggleWishlist(productId, btn) {
                btn.classList.toggle('active');
                console.log(`Товар ${productId} добавлен в избранное`);
            }
        });
    </script>
}