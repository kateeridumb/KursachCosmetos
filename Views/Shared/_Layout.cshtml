@using Newtonsoft.Json
@using CosmeticShopWeb.Models
@using CosmeticShopWeb.Controllers
@using System.Text
@{
    var encryptedData = Context.Request.Cookies["UserAuth"];
    var isAuthenticated = !string.IsNullOrEmpty(encryptedData);
    var isAdmin = false;
    var isManager = false;

    if (isAuthenticated)
    {
        try
        {
            // ДЕКОДИРУЕМ из base64
            var userJson = Encoding.UTF8.GetString(Convert.FromBase64String(encryptedData));
            var user = JsonConvert.DeserializeObject<BaseController.UserLoginResponse>(userJson);
            isAdmin = user?.RoleUs == "Администратор";
            isManager = user?.RoleUs == "Менеджер";

            // ДЛЯ ОТЛАДКИ - выведем в консоль
            <script>
                console.log('User Role:', '@user?.RoleUs');
                console.log('Is Admin:', '@isAdmin');
                console.log('Is Manager:', '@isManager');
            </script>
        }
        catch (Exception ex)
        {
            isAdmin = false;
            isManager = false;
            // Для отладки
            <script>console.error('Error decoding user:', '@ex.Message');</script>
        }
    }
}
<!DOCTYPE html>

<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CosmeticShop</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/layout.css" asp-append-version="true" />

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script src="js/site.js"></script>

</head>
<body>

    <header class="header-fixed">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" asp-controller="Home" asp-action="Index">Cosmetics</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Home" asp-action="Index">Главная</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Products" asp-action="Index">Товары</a>
                        </li>
                        @if (isAuthenticated)
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Cart" asp-action="Index">
                                    🛒 Корзина
                                    <span class="cart-count badge bg-danger" style="display: none;">0</span>
                                </a>
                            </li>
                        }
                    </ul>
                    <ul class="navbar-nav">
                        @if (isAuthenticated)
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    👤 Профиль
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile">Мой профиль</a></li>
                                    <li><a class="dropdown-item" asp-controller="Order" asp-action="MyOrders">Мои заказы</a></li>

                                    @if (isAdmin)
                                    {
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-controller="Admin" asp-action="Index">⚙️ Админ-панель</a></li>
                                    }
                                    @if (isManager)
                                    {
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-controller="Manager" asp-action="Index">⚙️ Менеджер-панель</a></li>
                                    }

                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="Logout">Выход</a></li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Account" asp-action="Register">Регистрация</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Account" asp-action="Login">Вход</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="content-wrapper">
        <main role="main">
            @RenderBody()
        </main>
    </div>

    <footer class="footer-fixed">
        <div class="container">
            <div class="footer-content">
                <span class="footer-brand">CosmeticShop</span>
                <span class="footer-copyright">&copy; @DateTime.Now.Year — Красота и уход</span>
                <div class="footer-links">
                    <a href="#">Контакты</a>
                    <a href="#">О нас</a>
                    <a href="#">Помощь</a>
                </div>
            </div>
        </div>
    </footer>

    @RenderSection("Scripts", required: false)
    @if (isAuthenticated)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                fetch('/Cart/GetCartCount')
                    .then(response => response.json())
                    .then(data => {
                        const cartCounter = document.querySelector('.cart-count');
                        if (cartCounter) {
                            cartCounter.textContent = data.count;
                            cartCounter.style.display = data.count > 0 ? 'inline' : 'none';
                        }
                    })
                    .catch(error => {
                        console.log('Ошибка загрузки корзины:', error);
                    });
            });
        </script>
    }
</body>
</html>